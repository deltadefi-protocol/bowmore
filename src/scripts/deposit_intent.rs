use whisky::{
    data::{byte_string, integer, Address, ByteString, Int, List, Map, OutputReference, Value},
    Asset, ConstrEnum, WError,
};

#[derive(Debug, Clone, ConstrEnum)]
pub enum IntentRedeemer {
    MintIntent,
    BurnIntent(List<Int>, ByteString, List<ByteString>),
}

#[derive(Debug, Clone, ConstrEnum)]
pub enum SignedMessage {
    Message(Int, Map<(ByteString, ByteString), Int>, OutputReference),
}

impl SignedMessage {
    pub fn from_plutus_data(message: &str) -> Result<Self, WError> {
        let plutus_data = whisky::csl::PlutusData::from_hex(message).map_err(|_e| {
            WError::new(
                "Failed to decode message as Plutus data",
                "InvalidMessageError",
            )
        })?;

        let datum_json = whisky::csl::decode_plutus_datum_to_json_value(
            &plutus_data,
            whisky::csl::PlutusDatumSchema::DetailedSchema,
        )
        .map_err(|_err| {
            WError::new("Failed to decode Plutus datum to JSON", "InvalidDatumError")
        })?;

        let fields = datum_json["fields"]
            .as_array()
            .ok_or_else(|| WError::new("Invalid SignedMessage structure", "InvalidDataError"))?;

        let vault_balance_int = fields[0]["int"]
            .as_i64()
            .ok_or_else(|| WError::new("Missing vault balance message", "InvalidDataError"))?;
        let vault_balance = Int::new(vault_balance_int as i128);

        let prices_map_json = &fields[1]["map"];
        let prices_array = prices_map_json
            .as_array()
            .ok_or_else(|| WError::new("Invalid prices map structure", "InvalidDataError"))?;

        let mut prices_map = Map::new(&[]);
        for entry in prices_array {
            let policy_id_byte = entry["k"]["list"][0]["bytes"].as_str().ok_or_else(|| {
                WError::new("Invalid policy ID in prices map", "InvalidDataError")
            })?;
            let asset_name_byte = entry["k"]["list"][1]["bytes"].as_str().ok_or_else(|| {
                WError::new("Invalid asset name in prices map", "InvalidDataError")
            })?;
            let value_int = entry["v"]["int"].as_i64().ok_or_else(|| {
                WError::new("Invalid price value in prices map", "InvalidDataError")
            })?;

            let key = (
                ByteString::new(policy_id_byte),
                ByteString::new(asset_name_byte),
            );
            let value = Int::new(value_int as i128);

            prices_map.insert(key, value);
        }

        let tx_hash = fields[2]["fields"][0]["bytes"]
            .as_str()
            .ok_or_else(|| WError::new("Missing tx hash in UTXO reference", "InvalidDataError"))?;

        let output_index = fields[2]["fields"][1]["int"].as_i64().ok_or_else(|| {
            WError::new("Missing output index in UTXO reference", "InvalidDataError")
        })?;

        let tx_hash_bytes = ByteString::new(tx_hash);
        let output_index_int = Int::new(output_index as i128);

        let utxo_ref_data = Box::new((tx_hash_bytes, output_index_int));
        let utxo_ref = OutputReference::new(utxo_ref_data);

        Ok(SignedMessage::Message(vault_balance, prices_map, utxo_ref))
    }
}

#[derive(Debug, Clone, ConstrEnum)]
pub enum DepositIntentDatum {
    Datum(Address, Value),
}

impl DepositIntentDatum {
    pub fn new(assets: &[Asset], address: &str) -> Self {
        let m_value = Value::from_asset_vec(assets);
        let w_address = whisky::deserialize_address(address);

        let (payment_key_hash, is_script_payment_key) = if w_address.pub_key_hash.is_empty() {
            (w_address.script_hash, true)
        } else {
            (w_address.pub_key_hash, false)
        };

        let (stake_key_hash, is_script_stake_key) = if w_address.stake_key_hash.is_empty() {
            (w_address.stake_key_script_hash, true)
        } else {
            (w_address.stake_key_hash, false)
        };

        let address_datum = Address::new(
            &payment_key_hash,
            Some(&stake_key_hash),
            is_script_payment_key,
            is_script_stake_key,
        );

        DepositIntentDatum::Datum(address_datum, m_value)
    }
}

use whisky::{
    utils::blueprint::{MintingBlueprint, SpendingBlueprint},
    BuilderDataType, LanguageVersion,
};

use crate::config::AppConfig;
use crate::scripts::plutus_loader::get_compiled_code_by_index;

pub fn deposit_intent_mint_blueprint(
    oracle_nft: &str,
    lp_decimal: i128,
) -> Result<MintingBlueprint, whisky::WError> {
    let mut blueprint = MintingBlueprint::new(LanguageVersion::V3);
    let compiled_code = "5922720101002229800aba4aba2aba1aba0aab9faab9eaab9dab9cab9a9bae0039bad00248888888888a60022a660089215665787065637420696e7075745f646174756d3a204465706f736974496e74656e74446174756d203d0a2020202020202020202020202020202020202020696e7075745f696e6c696e655f646174756d28696e7075742900168a9980224967657870656374207661756c745f6f7261636c655f6f75747075745f646174756d3a205661756c744f7261636c65446174756d203d0a202020202020202020206f75747075745f696e6c696e655f646174756d287661756c745f6f7261636c655f6f75747075742900168a9980224947657870656374205b7661756c745f6f7261636c655f6f75747075745d203d206f7574707574735f776974685f706f6c696379286f7574707574732c206f7261636c655f6e66742900168a9980224953657870656374204d657373616765207b207661756c745f62616c616e63652c207072696365732c207574786f5f726566207d3a204d657373616765203d0a202020202020202020207369676e65645f6461746100168a9980224964657870656374207661756c745f6f7261636c655f696e7075745f646174756d3a205661756c744f7261636c65446174756d203d0a20202020202020202020696e7075745f696e6c696e655f646174756d287661756c745f6f7261636c655f696e7075742900168a998022491872656465656d65723a20496e74656e7452656465656d657200164888889660026464653001300e3754003370e90014c04800e602400491112cc004c00c0122646644944c05c004c05cc060004c04cdd5002c4c966002600200b13259800801c4c8cc8966002600a003159800980c1baa00680140350194566002601000313259800800c03a264b3001001807c03e26644b3001001808c4c966002003012809404a0251332259800800c052264b300100180ac056264b30013025003899806003912cc00400a26601c00644b3001002807c4c96600200301b80dc06e0371323003302b004375c0028158c0a000902644c96600200301980cc066264600660520086eb40060328148c09800902440590221bac00180ac0550251811000a040375c00260420048110c07c00501d1bac001301e002807c03d01f180e000a0343018375400d00d405480a84c8c8c8cc88ca6002603e00314a13758603e00d3758603e00b3756603e60406040008911112cc004c038c080dd5002c4c9660020030058acc004c098006264944c09400600a81190231bac302430250068cc004c084dd5002c8c094c09800644464b300130153024375400314800226eb4c0a0c094dd5000a0443259800980a98121baa0018a60103d87a8000899198008009bab30293026375400444b30010018a6103d87a8000899192cc004cdc8803000c56600266e3c0180062601e66056605200497ae08a60103d87a80004099133004004302d00340986eb8c09c004c0a8005028204432330010010042259800800c5300103d87a8000899192cc004cdc8803000c56600266e3c0180062601c66054605000497ae08a60103d87a80004095133004004302c00340946eb8c098004c0a40050274dc3a4008911119914c004dd718150014dd6181518158014c9660026008604e6ea80062605660506ea80062a6604c92013265787065637420496e6c696e65446174756d287261775f646174756d29203d20696e7075742e6f75747075742e646174756d00164094605460566056604e6ea8c014c09cdd5000cdd6181500324444b30010028994c00400e33001302c3754007370290004dc02400537009000a444464646464653001375a6070003375c60706072607260726072003980091112cc004cdc400124061130010028acc004cdc380124061133004480088c0080062b300133710004901c44cc00ccdc7244103020408003370000490189180119bca4a2003124bded8c10140000101200040d881b1036488888ca600200300380120022225980099b89002480022600297ae08919194c00401a602200b23005330430020019bad30400024018607c0033001009804400500720749b87483f80e4466ec0008dd4000cdc6807244444664464b3001302a0048a60103d87a80008992cc006600260566eb4c0f800694294503b4530103d87a80008981219820181e800a5eb8103b4c004006440032225980099b8900148002297bdb18010140000101200089980119b8e0193370200e00266e0400400d03d48896600266e2400520008a5ef6c601014000010120008998014c004cdc0803800c00e032b8c19b8100100340f5004400481d088cc004888c8c8cdd8191ba73304630430013304630440014bd7019bb030420023042001304300198008034880060090039bad30420014019300100591000c00e0050014014446600490011192cc004cdc4800a40091598009817800c6600200900380148c02cdd4000a01a8acc004c0c800633001004801ccdc00012407f2300b37506028602c002806a2b30013370e004905f00c4c8cc0040048c030dd48009119803240044b3001300e00189801245008cc00401e00d33700002903fc8cc0100108c010cdc5001000a014410919800802400e66e00009207f918059ba9001401c81f903f207e8acc004cdc3800a401919800802400e66e0000920ff02919802a40044b30013370e004906600c492f7b63001014000010120008992cc004cdc38012417c0519800803c01a66012012440032300e3374a004002805a330010078034cdc0001241fe0329800804401e66014014440030019180799ba5003001404080810422cc004cdc4a41002800513370066e0000920ff134803a266e0000920f1014104820900d456600266e1c00520088acc004cdc38012417c0519800802400e6600c00c440032300b374e002804233001004801ccdc0001241fe0329800802c0126600e00e44003001918061ba70014034806903f456600266e1c005200a8acc004cdc3801241fc0513232330010012300d374c002446600e900112cc004c03c0062600497adef6c608919194c00401a4600c66098004003375a60920048030c8cdd81826000982618268009bac30470019800804c02260320028029043198030031100146600200900399b80002482fc0a464653001001801c8c038dd3000a0022225980099b89002480022600297adef6c608919194c00401a603600b230053304d0020019bad304a00240186466ec0c134004c134c138004dd61824000cc00402a01300140148220cc01c01c8800900d207e8925ef6c610140000101200040fc81f903f207e337060029020111119198008008011119803240044b3001300a0018980125eb8224646530010069180319823801000cdd69822001200c30420019800804401e6028002803103e11114c00401200700291980200091801800a0124dd7181c004cdd6181c002cdd6981c0024dd6981c001cdd6981c001244444444b3001302a303c375400d13259800800c5660026056607a6ea8006264b300100181b44c96600200303781bc0de26644b300100181cc4c96600200303a899912cc00400607913259800800c566002609400513303100322598008014566002606a608e6ea800e264b300100182044c966002003041820c1060831332259800800c10e264b30010018224112089132598009829001c4c8c8c8ca60026eb4c1540066eb4c154c158006646600200207444b30010018a5eb8226644b300132330010013233001001375660b660b860b06ea8010896600200314bd7044c8cc88c8cc004004dd5982e802112cc004006200713233061374e660c26ea4014cc184c178004cc184c17c0052f5c06600600660c600460c200282f8dd7182c80099801801982f001182e000a0b42259800800c528456600266e3cdd7182d9bac305b0010548a51899801001182e000a0aa416513305800233004004001899802002000a0a6305700130580014155375660aa00491112cc00400a09d13259800982d801c4c96600200319800800c566002b3001332259800800c00a2b3001305e0018992cc004cdc79bae305e00148900899b87375a60bc60be00201114a082c0c178dd6182e800c00905b20b614a06466002002646600200207444b30010018a5eb82264664464660020026eacc17c01089660020031003899198319ba733063375200a660c660c0002660c660c200297ae0330030033065002306300141846eb8c16c004cc00c00cc180008c17800505c112cc004006297ae0899912cc004cdc79bae305f00202689982f1ba700233004004001899802002000a0b2375860ba00260bc00282da29462a660ac921156c705f6d696e745f636865636b203f2046616c73650014a082aa2b300159800cc004c0acc8cc0040040bc8966002003148002260586600400460bc00282da29426466002002646600200207444b30010018a5eb82264664464660020026eacc17c01089660020031003899198319ba733063375200a660c660c0002660c660c200297ae0330030033065002306300141846eb8c16c004cc00c00cc180008c17800505c112cc004006297ae0899912cc004cdc79bae305f00204889982f1ba700233004004001899802002000a0b2375860ba00260bc00282d922259800800c00a2b3001305f0018992cc004cdc79bae305f001488100899b87375a60be60c000200914a082c8c17cdd6182f000c00905c20b84528c54cc15924119696e74656e745f6275726e5f636865636b203f2046616c73650014a082aa2b30015980099baf305b3058375406402714a31533056491167574786f5f7265665f636865636b203f2046616c73650014a082aa2b30015980099baf001323232323230433305f30600053305f30600043305f30600033305f375066e0008c028cc17cdd419b80300f00e00b3305f30600023305f30600013305f375066e000a002cc184c184004c180004c17cc17cc17c004c178004c174004c160dd5017c528c54cc159241277661756c745f6f7261636c655f6f75747075745f646174756d5f636865636b203f2046616c73650014a082aa2b300130343259800800c520008991816192cc00400a2900044c0b4cc004004c17c00905c112cc0040062900044c0b8cc008008c18000505d182e800a0b432330010013756606e60b26ea800c896600200314bd7044c8cc88c8cc004004dd5982f002112cc004006200713233062374e660c46ea4014cc188c17c004cc188c1800052f5c06600600660c800460c40028300dd7182d00099801801982f801182e800a0b68a518a9982b24812a69735f7661756c745f6f7261636c655f6f75747075745f76616c75655f636c65616e203f2046616c73650014a082aa2941055452820aa8a50415514a082aa0a2816a0a3051828c14505d192cc004c0d0c15cdd5000c4c16cc160dd5000c54cc15924012c65787065637420496e6c696e65446174756d287261775f646174756d29203d206f75747075742e646174756d0016415460b460b660b660ae6ea800609e82c0c1640090570c154006600244464b300130410018992cc00400600713259800800c01200900480244c96600260b6007006802a0b0375c00282d8c160005056182a1baa0048acc004c110006264b3001001801c4c966002003004802401200913259800982d801c01a00a82c0dd7000a0b63058001415860a86ea8012004828905118291baa003912cc004006297adef6c608991991191980080099803003182d002912cc0040062660b266ec0dd48021ba80034bd6f7b63044ca60026eb8c15c0066eb4c16000660b80049112cc004cdc8004001c4cc174cdd81ba9008375000e00b15980099b8f00800389982e99bb037520106ea001c0062660ba66ec0dd48019ba800233006006001416082c060b400282c0dd718290009bad30530013055001414d2259800800c52f5bded8c11323322323300100133006006305a0052259800800c4cc164cdd81ba9004374c00697adef6c608994c004dd7182b800cdd5982c000cc1700092225980099b9000800389982e99bb037520106e9801c0162b30013371e01000713305d337606ea4020dd3003800c4cc174cdd81ba9003374c0046600c00c00282c10580c1680050581bae3052001375660a600260aa002829a444b3001337120049000440063300100399b840024805266e2ccdc019b85002480512060001400c8282444653001001802400d0011112cc00400a200319800801cc16800a6600860b2004002801905748888c8cc004004014896600200310058992cc00400626600860b400400d133005305a00233003003001416060b400282ba444b30010028a60103d87a80008acc004c10000626072660aa60ac00497ae08cc00400e60ae0053024001400c828105424444445300130060069802802cc0100126002002911119194c004c0040064600c003230070014888ca600200304381bd2f5bded8c1480029000200222222259800802c566002009133068374c006660d06ea0008cc1a0dd4000a5eb822a660c89212e4261746368206465706f73697420696e74656e74205554784f73206e6f742066756c6c792070726f6365737365640016419d13322332259800982d18349baa0018acc004cdc79bae306d306a37540020ad159800804454cc1a1241234d6f7265205554784f7320617265207370656e74207468616e20737065636966696564001689919912cc004c168c1b0dd500144cc8966002003159800982e18371baa0018992cc0040060d513259800800c4c96600200306c8992cc0040060db13259800983c001c4c96600260c460e86ea8016264b300100183844c96600200313259800800c1ca264b30010018acc004c1f400a330010038992cc004c19c006264b300100183ac4c96600200315980098400080144c96600260d400313259800800c1e2264b30010018acc004c20c0400a33001001805c1e502f41e50800141e60f307983ca1080230810100141fc60fa6ea800a2b3001306d0018992cc0040060f113259800800c1e60f3079899912cc0040060f713259800800c1f20f907c899912cc0040060fd13259800800c1fe0ff07f8992cc004c2280400e02508001421c046eb40060fe845008c21c04005085011bad00130860100283e210e023084010014208046eb4004c20c0400a0f2842008c2040400507f183e9baa00283ba0f441e860f66ea80060ec83ea0ed07683b41d908101183f000a0f8307a37540051598009835000c56600260f46ea800a00d07441ed07441dc83b8c1e0dd5000c1cd02941cd07a41ce0e7073839a0fc307b00141e460f6005071838c1c60e283e0c1e4005077183a9baa005837a0e413305f001225980080144c8c8c8ca600266e0000405660fa009329800800cc074062603a008800888966002005100189919914c00401a61080200b32330010010052259800800c4cc21004cdd81ba9004374c00697adef6c608994c004dd7184100800cdd5984180800cc21c040092225980099b900080038998440099bb037520106e9801c0162b30013371e01000713259800983a1843009baa0018998448099bb03752012611402610e026ea800400a2004842008c1b0cc22004dd3194c004006605001130280034004444b30010028800c4c8cc8a600200d3090010059919800800802912cc0040062661200266ec0dd48021ba80034bd6f7b63044ca60026eb8c238040066eb4c23c040066126020049112cc004cdc8004001c4cc25004cdd81ba9008375000e00b15980099b8f0080038992cc004c20004c24804dd5000c4cc25404cdd81ba90093096013093013754002005100242400460f066128026ea0cdc000380125eb822661280266ec0dd48019ba800233006006001423c048478086122020028478090061bae308901001375a6114020026118020048450092f5c113308801337606ea400cdd300119803003000a10602420c04308501001420c048030dd7183e8009bab307e00130800100241f93370002c004911129983e19b964910a6c705f746f6b656e3a20003732660426ea4121220100153307c3372c92010d63616c5f6c705f73656e743a20003732660426ea0015220100153307c3372c92010c6c705f616464726573733a2000373266042006910100159800acc004cdc3cc004dd5982e183f1baa011824522100416c00b13375e61020260fc6ea804400e294107b466002025002800c011016454cc1f124011f4465706f73697420696e74656e74206f757470757420696e636f7272656374001641ec59800983301fc4cdc100083a44cdc199b8200103f302b02a41d93001001a40012298009bab307a002800c88c96600260d460f86ea8006266e00008cdc11bad308001307d37540026eb4c1f400e2a660f69216b65787065637420536f6d6528707269636529203d0a2020202020202020202020207072696365730a20202020202020202020202020207c3e2070616972732e6765745f66697273742828706f6c6963795f706169722e3173742c2061737365745f706169722e3173742929001641e864646600200207644b30010018a60103d87a80008992cc004cdd79ba7004307f001898331984100984000800a5eb8226600600661080200483e8c20804005080011983f183d8021983f183d80125eb810262048375660f460f600260ec6ea802226464b300100183941ca0e5072899912cc0040060e9133065375600244b30010028980398400080444c8c96600200307883c41e20f11332259800800c1ea0f507a89918031842808039bad00183d210a02375c00260fc004841808c1f0004c1fc00907d41d20e907441fc6eb8004c1e000907d183b000983c80120ee83720ea375600306d836c1b5078183a800a0e63075002835c1ae0d706b41d860e60028388c1bcdd5000c1a506c41a60d3069834a0e83070306d375400464b3001304a306d375400313071306e3754003153306c49013265787065637420496e6c696e65446174756d287261775f646174756d29203d20696e7075742e6f75747075742e646174756d001641ac60e060e260e260da6ea8c1c0c1c4c1b4dd5003c54cc1ad24013865787065637420536f6d65286f75745f7574786f29203d206f757470757473207c3e206c6973742e6174286f75747075745f696e64657829001641a8660220a400260de0126eb4c1b402106b466002011007803401500220ce8cc00402200f006802a004419c4445300100c802c012007002800a018306b3068375460d660d06ea8c118c1a0dd500118348029835002a0ce111192cc00400e2646466446601200466e2922101280059800800c4cdc52441035b5d2900006899b8a489035b5f20009800800ccdc52441025d2900006914c00402a00530070014029229800805400a002805100f20ca5980099b880014803a266e0120f2010018acc004cdc4000a41000513370066e01208014001480362c82f905f1bac3062002375a60c00026466ec0dd418300009ba73061001375400713259800800c4cdc52441027b7d00003899b8a489037b5f20003232330010010032259800800c400e264b30010018994c00402a60ca003337149101023a200098008054c19800600a805100a183400144ca6002015306500199b8a489023a200098008054c198006600e66008008004805100a183400120cc3068001419466e29220102207d0000341886eac00e264b3001001899b8a489025b5d00003899b8a489035b5f20009800800ccdc52441015d00003914c00401e0053004001401d229800803c00a002803900c20c43758007133005375a0060051323371491102682700329800800cc0ccdc68014cdc52450127000044004444b30013371000490004400626466453001006981c002ccdc599b800025980099b88002480522903045206e419066e2ccdc0000acc004cdc4000a40291481822903720c8004401866e0c00520203370c002901019b8e00400241846eb800d0651b8a4881022c200022323300100100322598009826000c4cdc52450130000038acc004cdc4000a40011337149101012d0033002002303200189980319b8400148050cdc599b803370a002900a240c000682e105c0b30013371201e029148002266e0ccdc1180080a009a4190028260dc0807411504f1bad00182220a4304f00141346eb8004c13800904f1826000a0943048375400703f41151323259800800c1060831332259800800c10e0870438992cc00400e08913259800800c11608b045822c4cc89660020030478992cc0040060910488244122264b3001305600389805982b00641250531bae001415860a60028288dd7000982900220a6305000341386eb40060868288dd6000982500141060828278c120004c12c00904940f504740f607b03d81ea096304800141186eac004c11c00a07503a81d20903045001410c6eb4004c11000a06e8228c108005040181f1baa00181aa07681ac0d606b035410c6080607a6ea801a2a6607692013465787065637420536f6d65287369676e65645f6461746129203d2063626f722e646573657269616c697365286d65737361676529001640e8303830380013037001303600130350013034303400440890011112cc004c06cc0b4dd5001c4c9660020030028992cc004006007003801c00e26644b3001001802c4c966002003006803401a00d1332259800800c022264b3001001804c02626644b3001001805c4c96600200300c806403226644b300100180744c96600200300f807c03e26644b3001001808c4c966002003012809404a26644b300100180a44c96600200301580ac05602b1332259800800c05e264b300100180c40620311332259800800c06a264b300100180dc06e03701b899912cc00400603b13259800800c07a03d01e80f44cc89660020030208992cc004006043021810c08626644b3001001811c4c966002003024812409204913259800982b001c4cc0f407089660020050288992cc00400605102881440a2264600660b40086eb800505a182b80120aa812a0a6375c00282b0c14c0050511bae0013052002414c60a00028270dd7000982780120a0304d001412c6eb8004c13000904d1825000a090375a00260920050184128608e0028228dd70009823001208e304400141086eb4004c10c00a0248220c10400503f1bad0013040002807a082303e00140f06eb4004c0f400a01881f0c0ec0050391bac001303a002804c02503b181c000a06c375c002606e00481c0c0d40050331bae001303400240d460640028180c0b8dd5001c00502b4086043021810a0601814802192cc004c04cc094dd5000c4c0a4c098dd5000c54cc091241b765787065637420536f6d65286f7261636c655f696e70757429203d0a20202020696e707574730a2020202020207c3e206c6973742e66696e64280a20202020202020202020666e287265665f696e7075743a20496e70757429207b0a2020202020202020202020207175616e746974795f6f66287265665f696e7075742e6f75747075742e76616c75652c206f7261636c655f6e66742c20222229203d3d20310a202020202020202020207d2c0a2020202020202020290016408c646600200201044b30010018a60103d87a80008992cc004c06260026eacc018c0a0dd5180318141baa00181252210040151300e3302a0014bd7044cc00c00cc0b00090251815000a050203c1980e8049980e9ba73232330010010042259800800c52f5c11332259800acc004cdd7981198101baa0020058991980080099198008009bab302530263022375400844b30010018a5eb82264664464660020026eacc09c01089660020031003899198159ba73302b375200a66056605000266056605200297ae033003003302d002302b00140a46eb8c08c004cc00c00cc0a0008c098005024112cc00400629422b30013371e6eb8c094dd618128008074528c4cc008008c09800501f20468a50407513302200233004004001899802002000a03a30210013022001407c60026603a66e9520023301d375200e97ae03301d4c103d87a80004bd7025eb80dd6180e0009ba548000c070004c06c004c058dd5002980a9baa00422323300100100322330030013002002805402a01500a40686eb8c05cc050dd50034590111b87480010100c044c048004c044004c030dd500945268a9980524811856616c696461746f722072657475726e65642066616c7365001365640241"; // Using index 0 for deposit intent spend
    blueprint
        .param_script(
            compiled_code,
            &[
                &byte_string(oracle_nft).to_string(),
                &integer(lp_decimal).to_string(),
            ],
            BuilderDataType::JSON,
        )
        .unwrap();
    Ok(blueprint)
}

pub fn deposit_intent_spend_blueprint(
    oracle_nft: &str,
    lp_decimal: i128,
) -> Result<SpendingBlueprint, whisky::WError> {
    let AppConfig { network_id, .. } = AppConfig::new();

    let mut blueprint =
        SpendingBlueprint::new(LanguageVersion::V3, network_id.parse().unwrap(), None);
    let compiled_code = "5922720101002229800aba4aba2aba1aba0aab9faab9eaab9dab9cab9a9bae0039bad00248888888888a60022a660089215665787065637420696e7075745f646174756d3a204465706f736974496e74656e74446174756d203d0a2020202020202020202020202020202020202020696e7075745f696e6c696e655f646174756d28696e7075742900168a9980224967657870656374207661756c745f6f7261636c655f6f75747075745f646174756d3a205661756c744f7261636c65446174756d203d0a202020202020202020206f75747075745f696e6c696e655f646174756d287661756c745f6f7261636c655f6f75747075742900168a9980224947657870656374205b7661756c745f6f7261636c655f6f75747075745d203d206f7574707574735f776974685f706f6c696379286f7574707574732c206f7261636c655f6e66742900168a9980224953657870656374204d657373616765207b207661756c745f62616c616e63652c207072696365732c207574786f5f726566207d3a204d657373616765203d0a202020202020202020207369676e65645f6461746100168a9980224964657870656374207661756c745f6f7261636c655f696e7075745f646174756d3a205661756c744f7261636c65446174756d203d0a20202020202020202020696e7075745f696e6c696e655f646174756d287661756c745f6f7261636c655f696e7075742900168a998022491872656465656d65723a20496e74656e7452656465656d657200164888889660026464653001300e3754003370e90014c04800e602400491112cc004c00c0122646644944c05c004c05cc060004c04cdd5002c4c966002600200b13259800801c4c8cc8966002600a003159800980c1baa00680140350194566002601000313259800800c03a264b3001001807c03e26644b3001001808c4c966002003012809404a0251332259800800c052264b300100180ac056264b30013025003899806003912cc00400a26601c00644b3001002807c4c96600200301b80dc06e0371323003302b004375c0028158c0a000902644c96600200301980cc066264600660520086eb40060328148c09800902440590221bac00180ac0550251811000a040375c00260420048110c07c00501d1bac001301e002807c03d01f180e000a0343018375400d00d405480a84c8c8c8cc88ca6002603e00314a13758603e00d3758603e00b3756603e60406040008911112cc004c038c080dd5002c4c9660020030058acc004c098006264944c09400600a81190231bac302430250068cc004c084dd5002c8c094c09800644464b300130153024375400314800226eb4c0a0c094dd5000a0443259800980a98121baa0018a60103d87a8000899198008009bab30293026375400444b30010018a6103d87a8000899192cc004cdc8803000c56600266e3c0180062601e66056605200497ae08a60103d87a80004099133004004302d00340986eb8c09c004c0a8005028204432330010010042259800800c5300103d87a8000899192cc004cdc8803000c56600266e3c0180062601c66054605000497ae08a60103d87a80004095133004004302c00340946eb8c098004c0a40050274dc3a4008911119914c004dd718150014dd6181518158014c9660026008604e6ea80062605660506ea80062a6604c92013265787065637420496e6c696e65446174756d287261775f646174756d29203d20696e7075742e6f75747075742e646174756d00164094605460566056604e6ea8c014c09cdd5000cdd6181500324444b30010028994c00400e33001302c3754007370290004dc02400537009000a444464646464653001375a6070003375c60706072607260726072003980091112cc004cdc400124061130010028acc004cdc380124061133004480088c0080062b300133710004901c44cc00ccdc7244103020408003370000490189180119bca4a2003124bded8c10140000101200040d881b1036488888ca600200300380120022225980099b89002480022600297ae08919194c00401a602200b23005330430020019bad30400024018607c0033001009804400500720749b87483f80e4466ec0008dd4000cdc6807244444664464b3001302a0048a60103d87a80008992cc006600260566eb4c0f800694294503b4530103d87a80008981219820181e800a5eb8103b4c004006440032225980099b8900148002297bdb18010140000101200089980119b8e0193370200e00266e0400400d03d48896600266e2400520008a5ef6c601014000010120008998014c004cdc0803800c00e032b8c19b8100100340f5004400481d088cc004888c8c8cdd8191ba73304630430013304630440014bd7019bb030420023042001304300198008034880060090039bad30420014019300100591000c00e0050014014446600490011192cc004cdc4800a40091598009817800c6600200900380148c02cdd4000a01a8acc004c0c800633001004801ccdc00012407f2300b37506028602c002806a2b30013370e004905f00c4c8cc0040048c030dd48009119803240044b3001300e00189801245008cc00401e00d33700002903fc8cc0100108c010cdc5001000a014410919800802400e66e00009207f918059ba9001401c81f903f207e8acc004cdc3800a401919800802400e66e0000920ff02919802a40044b30013370e004906600c492f7b63001014000010120008992cc004cdc38012417c0519800803c01a66012012440032300e3374a004002805a330010078034cdc0001241fe0329800804401e66014014440030019180799ba5003001404080810422cc004cdc4a41002800513370066e0000920ff134803a266e0000920f1014104820900d456600266e1c00520088acc004cdc38012417c0519800802400e6600c00c440032300b374e002804233001004801ccdc0001241fe0329800802c0126600e00e44003001918061ba70014034806903f456600266e1c005200a8acc004cdc3801241fc0513232330010012300d374c002446600e900112cc004c03c0062600497adef6c608919194c00401a4600c66098004003375a60920048030c8cdd81826000982618268009bac30470019800804c02260320028029043198030031100146600200900399b80002482fc0a464653001001801c8c038dd3000a0022225980099b89002480022600297adef6c608919194c00401a603600b230053304d0020019bad304a00240186466ec0c134004c134c138004dd61824000cc00402a01300140148220cc01c01c8800900d207e8925ef6c610140000101200040fc81f903f207e337060029020111119198008008011119803240044b3001300a0018980125eb8224646530010069180319823801000cdd69822001200c30420019800804401e6028002803103e11114c00401200700291980200091801800a0124dd7181c004cdd6181c002cdd6981c0024dd6981c001cdd6981c001244444444b3001302a303c375400d13259800800c5660026056607a6ea8006264b300100181b44c96600200303781bc0de26644b300100181cc4c96600200303a899912cc00400607913259800800c566002609400513303100322598008014566002606a608e6ea800e264b300100182044c966002003041820c1060831332259800800c10e264b30010018224112089132598009829001c4c8c8c8ca60026eb4c1540066eb4c154c158006646600200207444b30010018a5eb8226644b300132330010013233001001375660b660b860b06ea8010896600200314bd7044c8cc88c8cc004004dd5982e802112cc004006200713233061374e660c26ea4014cc184c178004cc184c17c0052f5c06600600660c600460c200282f8dd7182c80099801801982f001182e000a0b42259800800c528456600266e3cdd7182d9bac305b0010548a51899801001182e000a0aa416513305800233004004001899802002000a0a6305700130580014155375660aa00491112cc00400a09d13259800982d801c4c96600200319800800c566002b3001332259800800c00a2b3001305e0018992cc004cdc79bae305e00148900899b87375a60bc60be00201114a082c0c178dd6182e800c00905b20b614a06466002002646600200207444b30010018a5eb82264664464660020026eacc17c01089660020031003899198319ba733063375200a660c660c0002660c660c200297ae0330030033065002306300141846eb8c16c004cc00c00cc180008c17800505c112cc004006297ae0899912cc004cdc79bae305f00202689982f1ba700233004004001899802002000a0b2375860ba00260bc00282da29462a660ac921156c705f6d696e745f636865636b203f2046616c73650014a082aa2b300159800cc004c0acc8cc0040040bc8966002003148002260586600400460bc00282da29426466002002646600200207444b30010018a5eb82264664464660020026eacc17c01089660020031003899198319ba733063375200a660c660c0002660c660c200297ae0330030033065002306300141846eb8c16c004cc00c00cc180008c17800505c112cc004006297ae0899912cc004cdc79bae305f00204889982f1ba700233004004001899802002000a0b2375860ba00260bc00282d922259800800c00a2b3001305f0018992cc004cdc79bae305f001488100899b87375a60be60c000200914a082c8c17cdd6182f000c00905c20b84528c54cc15924119696e74656e745f6275726e5f636865636b203f2046616c73650014a082aa2b30015980099baf305b3058375406402714a31533056491167574786f5f7265665f636865636b203f2046616c73650014a082aa2b30015980099baf001323232323230433305f30600053305f30600043305f30600033305f375066e0008c028cc17cdd419b80300f00e00b3305f30600023305f30600013305f375066e000a002cc184c184004c180004c17cc17cc17c004c178004c174004c160dd5017c528c54cc159241277661756c745f6f7261636c655f6f75747075745f646174756d5f636865636b203f2046616c73650014a082aa2b300130343259800800c520008991816192cc00400a2900044c0b4cc004004c17c00905c112cc0040062900044c0b8cc008008c18000505d182e800a0b432330010013756606e60b26ea800c896600200314bd7044c8cc88c8cc004004dd5982f002112cc004006200713233062374e660c46ea4014cc188c17c004cc188c1800052f5c06600600660c800460c40028300dd7182d00099801801982f801182e800a0b68a518a9982b24812a69735f7661756c745f6f7261636c655f6f75747075745f76616c75655f636c65616e203f2046616c73650014a082aa2941055452820aa8a50415514a082aa0a2816a0a3051828c14505d192cc004c0d0c15cdd5000c4c16cc160dd5000c54cc15924012c65787065637420496e6c696e65446174756d287261775f646174756d29203d206f75747075742e646174756d0016415460b460b660b660ae6ea800609e82c0c1640090570c154006600244464b300130410018992cc00400600713259800800c01200900480244c96600260b6007006802a0b0375c00282d8c160005056182a1baa0048acc004c110006264b3001001801c4c966002003004802401200913259800982d801c01a00a82c0dd7000a0b63058001415860a86ea8012004828905118291baa003912cc004006297adef6c608991991191980080099803003182d002912cc0040062660b266ec0dd48021ba80034bd6f7b63044ca60026eb8c15c0066eb4c16000660b80049112cc004cdc8004001c4cc174cdd81ba9008375000e00b15980099b8f00800389982e99bb037520106ea001c0062660ba66ec0dd48019ba800233006006001416082c060b400282c0dd718290009bad30530013055001414d2259800800c52f5bded8c11323322323300100133006006305a0052259800800c4cc164cdd81ba9004374c00697adef6c608994c004dd7182b800cdd5982c000cc1700092225980099b9000800389982e99bb037520106e9801c0162b30013371e01000713305d337606ea4020dd3003800c4cc174cdd81ba9003374c0046600c00c00282c10580c1680050581bae3052001375660a600260aa002829a444b3001337120049000440063300100399b840024805266e2ccdc019b85002480512060001400c8282444653001001802400d0011112cc00400a200319800801cc16800a6600860b2004002801905748888c8cc004004014896600200310058992cc00400626600860b400400d133005305a00233003003001416060b400282ba444b30010028a60103d87a80008acc004c10000626072660aa60ac00497ae08cc00400e60ae0053024001400c828105424444445300130060069802802cc0100126002002911119194c004c0040064600c003230070014888ca600200304381bd2f5bded8c1480029000200222222259800802c566002009133068374c006660d06ea0008cc1a0dd4000a5eb822a660c89212e4261746368206465706f73697420696e74656e74205554784f73206e6f742066756c6c792070726f6365737365640016419d13322332259800982d18349baa0018acc004cdc79bae306d306a37540020ad159800804454cc1a1241234d6f7265205554784f7320617265207370656e74207468616e20737065636966696564001689919912cc004c168c1b0dd500144cc8966002003159800982e18371baa0018992cc0040060d513259800800c4c96600200306c8992cc0040060db13259800983c001c4c96600260c460e86ea8016264b300100183844c96600200313259800800c1ca264b30010018acc004c1f400a330010038992cc004c19c006264b300100183ac4c96600200315980098400080144c96600260d400313259800800c1e2264b30010018acc004c20c0400a33001001805c1e502f41e50800141e60f307983ca1080230810100141fc60fa6ea800a2b3001306d0018992cc0040060f113259800800c1e60f3079899912cc0040060f713259800800c1f20f907c899912cc0040060fd13259800800c1fe0ff07f8992cc004c2280400e02508001421c046eb40060fe845008c21c04005085011bad00130860100283e210e023084010014208046eb4004c20c0400a0f2842008c2040400507f183e9baa00283ba0f441e860f66ea80060ec83ea0ed07683b41d908101183f000a0f8307a37540051598009835000c56600260f46ea800a00d07441ed07441dc83b8c1e0dd5000c1cd02941cd07a41ce0e7073839a0fc307b00141e460f6005071838c1c60e283e0c1e4005077183a9baa005837a0e413305f001225980080144c8c8c8ca600266e0000405660fa009329800800cc074062603a008800888966002005100189919914c00401a61080200b32330010010052259800800c4cc21004cdd81ba9004374c00697adef6c608994c004dd7184100800cdd5984180800cc21c040092225980099b900080038998440099bb037520106e9801c0162b30013371e01000713259800983a1843009baa0018998448099bb03752012611402610e026ea800400a2004842008c1b0cc22004dd3194c004006605001130280034004444b30010028800c4c8cc8a600200d3090010059919800800802912cc0040062661200266ec0dd48021ba80034bd6f7b63044ca60026eb8c238040066eb4c23c040066126020049112cc004cdc8004001c4cc25004cdd81ba9008375000e00b15980099b8f0080038992cc004c20004c24804dd5000c4cc25404cdd81ba90093096013093013754002005100242400460f066128026ea0cdc000380125eb822661280266ec0dd48019ba800233006006001423c048478086122020028478090061bae308901001375a6114020026118020048450092f5c113308801337606ea400cdd300119803003000a10602420c04308501001420c048030dd7183e8009bab307e00130800100241f93370002c004911129983e19b964910a6c705f746f6b656e3a20003732660426ea4121220100153307c3372c92010d63616c5f6c705f73656e743a20003732660426ea0015220100153307c3372c92010c6c705f616464726573733a2000373266042006910100159800acc004cdc3cc004dd5982e183f1baa011824522100416c00b13375e61020260fc6ea804400e294107b466002025002800c011016454cc1f124011f4465706f73697420696e74656e74206f757470757420696e636f7272656374001641ec59800983301fc4cdc100083a44cdc199b8200103f302b02a41d93001001a40012298009bab307a002800c88c96600260d460f86ea8006266e00008cdc11bad308001307d37540026eb4c1f400e2a660f69216b65787065637420536f6d6528707269636529203d0a2020202020202020202020207072696365730a20202020202020202020202020207c3e2070616972732e6765745f66697273742828706f6c6963795f706169722e3173742c2061737365745f706169722e3173742929001641e864646600200207644b30010018a60103d87a80008992cc004cdd79ba7004307f001898331984100984000800a5eb8226600600661080200483e8c20804005080011983f183d8021983f183d80125eb810262048375660f460f600260ec6ea802226464b300100183941ca0e5072899912cc0040060e9133065375600244b30010028980398400080444c8c96600200307883c41e20f11332259800800c1ea0f507a89918031842808039bad00183d210a02375c00260fc004841808c1f0004c1fc00907d41d20e907441fc6eb8004c1e000907d183b000983c80120ee83720ea375600306d836c1b5078183a800a0e63075002835c1ae0d706b41d860e60028388c1bcdd5000c1a506c41a60d3069834a0e83070306d375400464b3001304a306d375400313071306e3754003153306c49013265787065637420496e6c696e65446174756d287261775f646174756d29203d20696e7075742e6f75747075742e646174756d001641ac60e060e260e260da6ea8c1c0c1c4c1b4dd5003c54cc1ad24013865787065637420536f6d65286f75745f7574786f29203d206f757470757473207c3e206c6973742e6174286f75747075745f696e64657829001641a8660220a400260de0126eb4c1b402106b466002011007803401500220ce8cc00402200f006802a004419c4445300100c802c012007002800a018306b3068375460d660d06ea8c118c1a0dd500118348029835002a0ce111192cc00400e2646466446601200466e2922101280059800800c4cdc52441035b5d2900006899b8a489035b5f20009800800ccdc52441025d2900006914c00402a00530070014029229800805400a002805100f20ca5980099b880014803a266e0120f2010018acc004cdc4000a41000513370066e01208014001480362c82f905f1bac3062002375a60c00026466ec0dd418300009ba73061001375400713259800800c4cdc52441027b7d00003899b8a489037b5f20003232330010010032259800800c400e264b30010018994c00402a60ca003337149101023a200098008054c19800600a805100a183400144ca6002015306500199b8a489023a200098008054c198006600e66008008004805100a183400120cc3068001419466e29220102207d0000341886eac00e264b3001001899b8a489025b5d00003899b8a489035b5f20009800800ccdc52441015d00003914c00401e0053004001401d229800803c00a002803900c20c43758007133005375a0060051323371491102682700329800800cc0ccdc68014cdc52450127000044004444b30013371000490004400626466453001006981c002ccdc599b800025980099b88002480522903045206e419066e2ccdc0000acc004cdc4000a40291481822903720c8004401866e0c00520203370c002901019b8e00400241846eb800d0651b8a4881022c200022323300100100322598009826000c4cdc52450130000038acc004cdc4000a40011337149101012d0033002002303200189980319b8400148050cdc599b803370a002900a240c000682e105c0b30013371201e029148002266e0ccdc1180080a009a4190028260dc0807411504f1bad00182220a4304f00141346eb8004c13800904f1826000a0943048375400703f41151323259800800c1060831332259800800c10e0870438992cc00400e08913259800800c11608b045822c4cc89660020030478992cc0040060910488244122264b3001305600389805982b00641250531bae001415860a60028288dd7000982900220a6305000341386eb40060868288dd6000982500141060828278c120004c12c00904940f504740f607b03d81ea096304800141186eac004c11c00a07503a81d20903045001410c6eb4004c11000a06e8228c108005040181f1baa00181aa07681ac0d606b035410c6080607a6ea801a2a6607692013465787065637420536f6d65287369676e65645f6461746129203d2063626f722e646573657269616c697365286d65737361676529001640e8303830380013037001303600130350013034303400440890011112cc004c06cc0b4dd5001c4c9660020030028992cc004006007003801c00e26644b3001001802c4c966002003006803401a00d1332259800800c022264b3001001804c02626644b3001001805c4c96600200300c806403226644b300100180744c96600200300f807c03e26644b3001001808c4c966002003012809404a26644b300100180a44c96600200301580ac05602b1332259800800c05e264b300100180c40620311332259800800c06a264b300100180dc06e03701b899912cc00400603b13259800800c07a03d01e80f44cc89660020030208992cc004006043021810c08626644b3001001811c4c966002003024812409204913259800982b001c4cc0f407089660020050288992cc00400605102881440a2264600660b40086eb800505a182b80120aa812a0a6375c00282b0c14c0050511bae0013052002414c60a00028270dd7000982780120a0304d001412c6eb8004c13000904d1825000a090375a00260920050184128608e0028228dd70009823001208e304400141086eb4004c10c00a0248220c10400503f1bad0013040002807a082303e00140f06eb4004c0f400a01881f0c0ec0050391bac001303a002804c02503b181c000a06c375c002606e00481c0c0d40050331bae001303400240d460640028180c0b8dd5001c00502b4086043021810a0601814802192cc004c04cc094dd5000c4c0a4c098dd5000c54cc091241b765787065637420536f6d65286f7261636c655f696e70757429203d0a20202020696e707574730a2020202020207c3e206c6973742e66696e64280a20202020202020202020666e287265665f696e7075743a20496e70757429207b0a2020202020202020202020207175616e746974795f6f66287265665f696e7075742e6f75747075742e76616c75652c206f7261636c655f6e66742c20222229203d3d20310a202020202020202020207d2c0a2020202020202020290016408c646600200201044b30010018a60103d87a80008992cc004c06260026eacc018c0a0dd5180318141baa00181252210040151300e3302a0014bd7044cc00c00cc0b00090251815000a050203c1980e8049980e9ba73232330010010042259800800c52f5c11332259800acc004cdd7981198101baa0020058991980080099198008009bab302530263022375400844b30010018a5eb82264664464660020026eacc09c01089660020031003899198159ba73302b375200a66056605000266056605200297ae033003003302d002302b00140a46eb8c08c004cc00c00cc0a0008c098005024112cc00400629422b30013371e6eb8c094dd618128008074528c4cc008008c09800501f20468a50407513302200233004004001899802002000a03a30210013022001407c60026603a66e9520023301d375200e97ae03301d4c103d87a80004bd7025eb80dd6180e0009ba548000c070004c06c004c058dd5002980a9baa00422323300100100322330030013002002805402a01500a40686eb8c05cc050dd50034590111b87480010100c044c048004c044004c030dd500945268a9980524811856616c696461746f722072657475726e65642066616c7365001365640241"; // Using index 0 for deposit intent spend
    blueprint
        .param_script(
            compiled_code,
            &[
                &byte_string(oracle_nft).to_string(),
                &integer(lp_decimal).to_string(),
            ],
            BuilderDataType::JSON,
        )
        .unwrap();
    Ok(blueprint)
}

#[cfg(test)]
mod tests {

    use super::*;
    use dotenv::dotenv;

    #[test]
    fn test_deposit_intent_mint_blueprint() {
        dotenv().ok();

        let blueprint = deposit_intent_mint_blueprint(
            "c9e99dda2af8e97d8ccde3254fc1c16926fbbf6508929dad6518d1b83f389e92",
            1000000,
        )
        .unwrap();
        println!("blueprint: {:?}", blueprint);
        assert_eq!(blueprint.hash, "TODO");
        assert_eq!(blueprint.cbor, "TODO");
    }

    #[test]
    fn test_deposit_intent_spend_blueprint() {
        dotenv().ok();

        let blueprint = deposit_intent_spend_blueprint("todo", 1000000).unwrap();
        assert_eq!(blueprint.hash, "TODO");
        assert_eq!(blueprint.cbor, "TODO");
    }
}
